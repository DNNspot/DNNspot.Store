(function($){jQuery.fn.popeye=function(options){var obj=jQuery(this);var opts=jQuery.extend({},jQuery.fn.popeye.defaults,options);function debug(msg){if(window.console&&window.console.log&&opts.debug){window.console.log(msg);}}
return this.each(function(){function display(i,transition){transition=transition||false;var stageIm={backgroundImage:'url('+im.small[i]+')',backgroundPosition:'center'};if(transition){ppyStageWrap.addClass(opts.lclass);ppyStage.fadeTo(100,0,function(){updateCounter(i);ppyStage.css(stageIm);});}
else{ppyStage.css(stageIm);updateCounter(i);}
preloader.onload=function(){ppyStageWrap.removeClass(opts.lclass);if(transition){ppyStage.fadeTo(100,1);displayCaption(im.title[i]);}};if(enlarged){enlarge(i);}
else{preloader.src=im.small[i];debug('jQuery.fn.popeye.display: Thumbnail '+i+' loaded');preloader2.onload=function(){debug('jQuery.fn.popeye.display: Image '+i+' loaded');};preloader2.src=im.large[i];}}
function updateCounter(i){ppyTotal.text(' '+tot);ppyCur.text((i+1)+' ');debug('jQuery.fn.popeye.updateCounter: Displaying image '+(i+1)+' of '+tot);}
function preloadAdjacent(i){var next=i;if(next<(tot-1)){next++;}else{next=0;}
preloaderNext.onload=function(){debug('jQuery.fn.popeye.preloadAdjacent: Next image ('+next+') loaded');};preloaderNext.src=im.large[next];var prev=i;if(prev<=0){prev=tot-1;}else{prev--;}
preloaderPrev.onload=function(){debug('jQuery.fn.popeye.preloadAdjacent: Previous image ('+prev+') loaded');};preloaderPrev.src=im.large[prev];}
function enlarge(i){enlarged=true;debug('jQuery.fn.popeye.enlarge: Entering ENLARGED MODE');ppyStageWrap.addClass(opts.lclass);ppyStage.fadeTo((opts.duration/2),0);obj.addClass(opts.eclass);preloader.onload=function(){ppyStageWrap.removeClass(opts.lclass);var imWidth=preloader.width;var imHeight=preloader.height;var cssStageTo={width:imWidth,height:imHeight};var cssStageIm={backgroundImage:'url('+im.large[i]+')',backgroundPosition:'left top'};hideCaption(true);ppyStage.animate(cssStageTo,{queue:false,duration:opts.duration,easing:opts.easing,complete:function(){ppySwitch.removeClass('ppy-enlarge');ppySwitch.addClass('ppy-compact');ppySwitch.html(opts.clabel);ppySwitch.unbind('click');ppySwitch.click(function(){compact(cur);return false;});ppyStageWrap.click(function(){compact(cur);return false;});ppyStageWrap.attr('title',opts.clabel);updateCounter(i);jQuery(this).css(cssStageIm).fadeTo((opts.duration/2),1);displayCaption(im.title[i]);preloadAdjacent(i);}});};preloader.src=im.large[i];}
function compact(i){enlarged=false;debug('jQuery.fn.popeye.compact: Entering COMPACT MODE');hideCaption(true);ppyStage.fadeTo((opts.duration/2),0).animate(cssCompactStage,{queue:false,duration:opts.duration,easing:opts.easing,complete:function(){obj.removeClass(opts.eclass);ppySwitch.addClass('ppy-enlarge');ppySwitch.removeClass('ppy-compact');ppySwitch.html(opts.blabel);ppySwitch.unbind('click');ppySwitch.click(function(){enlarge(cur);return false;});ppyStageWrap.removeAttr('title');ppyStageWrap.unbind('click');display(cur);jQuery(this).fadeTo((opts.duration/2),1,function(){displayCaption(im.title[i]);});}});}
function displayCaption(cap){ppyText.text(cap);if(opts.countpos=='caption'){updateCounter(cur);}
if(cap){var cssPpyCaption={visibility:'visible',width:ppyStage.outerWidth()};ppyCap.css(cssPpyCaption);ppyCap.animate({"height":ppyTextWrap.outerHeight()},{queue:false,duration:90,easing:opts.easing});}
else{hideCaption(true);}}
function hideCaption(transition){transition=transition||false;var cssPpyCaption={visibility:'hidden',overflow:'hidden',width:maxWidth};var duration=false;if(transition){duration=70;}
else{duration=0;}
ppyCap.animate({"height":'0px'},{queue:false,duration:duration,easing:opts.easing,complete:function(){ppyCap.css(cssPpyCaption);}});}
function init(){obj.find('li').each(function(i){im.width[i]=jQuery(this).find('img').width();im.height[i]=jQuery(this).find('img').height();debug('jQuery.fn.popeye.init -> im.width['+i+']: '+im.width[i]+', im.height['+i+']: '+im.height[i]);if(maxWidth>im.width[i]){maxWidth=im.width[i];}
if(maxHeight>im.height[i]){maxHeight=im.height[i];}});debug('jQuery.fn.popeye.init -> maxWidth: '+maxWidth+', maxHeight: '+maxHeight);cssCompactStage={width:maxWidth,height:maxHeight};if(!opts.toolsAlwaysVisible){cssPpyTools={opacity:0};}
debug('jQuery.fn.popeye.init -> Starting in COMPACT MODE');obj.find('ul').remove();if(opts.nojsclass){obj.find('.'+opts.nojsclass).remove();}
obj.append(ppyStageWrap);ppyStageWrap.append(ppyStage);ppyStage.append(ppyTools);if(opts.countpos=='overlay'){ppyStage.append(ppyCount);}
ppyTools.append(ppyPrev);ppyTools.append(ppySwitch);ppyTools.append(ppyNext);if(opts.caption){ppyStageWrap.after(ppyCap);}
ppyStageWrap.append(ppyTools);ppyCount.append(ppyCur);ppyCount.append(ppyTotal);ppyCur.after(opts.oflabel);ppyCap.append(ppyTextWrap);if(opts.countpos=='caption'){ppyTextWrap.prepend(ppyCount);}
ppyTextWrap.append(ppyText);if(opts.jsclass){obj.addClass(opts.jsclass);}
if(opts.direction=='left'){ppyTools.addClass(opts.dlclass);}
else if(opts.direction=='right'){ppyTools.addClass(opts.drclass);}
ppyStage.css(cssCompactStage);ppyTools.css(cssPpyTools);if(tot<=1){ppyNext.css('visibility','hidden');ppyPrev.css('visibility','hidden');}
display(cur);hideCaption();var imHeight=ppyStageWrap.outerHeight();var imWidth=ppyStageWrap.outerWidth();var strMarginTop=obj.css('marginTop');if(strMarginTop=='auto'){strMarginTop='0';}
var strMarginLeft=obj.css('marginLeft');if(strMarginLeft=='auto'){strMarginLeft='0';}
var imTop=obj.offset().top-parseInt(strMarginTop,10);var imLeft=obj.offset().left-parseInt(strMarginLeft,10);var imRight=jQuery(window).width()-(obj.offset().left+imWidth)-parseInt(obj.css('marginRight'),10);var imFloat=obj.css('float');var imMarginTop=obj.css('margin-top');var imMarginRight=obj.css('margin-right');var imMarginBottom=obj.css('margin-bottom');var imMarginLeft=obj.css('margin-left');var cssPlaceholder={height:imHeight,width:imWidth,float:imFloat,marginTop:imMarginTop,marginRight:imMarginRight,marginBottom:imMarginBottom,marginLeft:imMarginLeft};var cssAbsolutePpy={position:'absolute',zIndex:'100'};if(imTop){cssAbsolutePpy.top=imTop;}
if(opts.direction=='left'&&imLeft){cssAbsolutePpy.left=imLeft;}
else if(opts.direction=='right'&&imRight){cssAbsolutePpy.right=imRight;}
ppyPlaceholder.css(cssPlaceholder);obj.after(ppyPlaceholder);obj.appendTo(jQuery('body'));obj.css(cssAbsolutePpy);ppyStage.hover(function(e){if(!opts.toolsAlwaysVisible)
ppyTools.stop().fadeTo(100,opts.opacity);},function(e){if(!opts.toolsAlwaysVisible)
ppyTools.stop().fadeTo(500,0);});ppyTools.mouseleave(function(e){if(!opts.toolsAlwaysVisible)
ppyTools.stop().fadeTo(500,0);});ppyTools.mouseenter(function(e){if(!opts.toolsAlwaysVisible)
ppyTools.stop().fadeTo(100,opts.opacity);});obj.hover(function(e){displayCaption(im.title[cur]);},function(e){hideCaption(true);});ppyPrev.click(function(){if(cur<=0){cur=tot-1;}else{cur--;}
display(cur,true);return false;});ppyNext.click(function(){if(cur<(tot-1)){cur++;}else{cur=0;}
display(cur,true);return false;});ppySwitch.click(function(){enlarge(cur);return false;});}
var preloader=new Image();var preloader2=new Image();var preloaderNext=new Image();var preloaderPrev=new Image();var preloaders=[];var ppyPlaceholder=jQuery('<div class="ppy-placeholder" />');var ppyStageWrap=jQuery('<div class="ppy-stagewrap" />');var ppyStage=jQuery('<div class="ppy-stage" />');var ppyTools=jQuery('<div class="ppy-tools" />');var ppyPrev=jQuery('<div class="ppy-prev">'+opts.plabel+'</div>');var ppyNext=jQuery('<div class="ppy-next">'+opts.nlabel+'</div>');var ppySwitch=jQuery('<div class="ppy-enlarge">'+opts.blabel+'</div>');var ppyCap=jQuery('<div class="ppy-cap" />');var ppyCount=jQuery('<div class="ppy-count" />');var ppyCur=jQuery('<em class="ppy-cur" />');var ppyTotal=jQuery('<em class="ppy-total" />');var ppyTextWrap=jQuery('<div class="ppy-textwrap" />');var ppyText=jQuery('<span class="ppy-text" />');var im={small:[],title:[],large:[],width:[],height:[]};var maxWidth=10000;var maxHeight=10000;var cur=0;var tot=obj.find('img').length;var togo=tot;debug('jQuery.fn.popeye -> '+tot+' thumbnails found.');var cssCompactStage={};var cssPpyTools={};var enlarged=false;obj.find('li').each(function(i){im.small[i]=jQuery(this).find('img').attr('src');im.title[i]=jQuery(this).find('img').attr('alt');im.large[i]=jQuery(this).find('a').attr('href');debug('jQuery.fn.popeye -> Loading "'+im.small[i]+'"');jQuery(this).find('img').load(function(){if(--togo<1){debug('jQuery.fn.popeye -> All thumbnails loaded!');init();}}).attr('src',im.small[i]);});});};jQuery.fn.popeye.defaults={jsclass:'ppy-js',nojsclass:'ppy-no-js',eclass:'ppy-expanded',lclass:'ppy-loading',dlclass:'ppy-left',drclass:'ppy-right',direction:'left',duration:250,opacity:0.7,toolsAlwaysVisible:false,countpos:'overlay',caption:true,easing:'swing',nlabel:'',plabel:'',oflabel:'of',blabel:'',clabel:'Click to close',debug:false};})(jQuery);